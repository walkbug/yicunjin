<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>日历</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/iconfont/iconfont.css" />
    <link rel="stylesheet" type="text/css" href="../css/iconfont2/iconfont.css" />
    <style type="text/css">
        .text-white {
            color: #ffffff !important;
        }
        .aui-grid [class*=aui-col-] {
            padding: 0.75rem 0;
        }
    </style>
    <style>
    @font-face
    {
    font-family: myFirstFont;
    src: url('../image/fangzhengyyj.ttf'); /* IE9+ */
    }

    div
    {
    font-family:myFirstFont;
    }
    </style>
</head>
<body style="background:url('../image/bgcc.png') no-repeat;background-size: cover;display：inline">
    <!-- 顶部 -->
    <!-- <header class="aui-bar aui-bar-nav" id="aui-header" style="background-color:#a33fad">
        <a class="aui-btn aui-pull-left" tapmode onclick="closeWin()">
            <span class="aui-iconfont aui-icon-left"></span>
        </a>
        <div class="aui-title">日历</div>
    </header> -->

    <header class="aui-bar aui-bar-nav" id="aui-header" style="background-color:#a33fad">
        <a class="aui-btn aui-pull-left" tapmode onclick="closeWin()">
            <span class="aui-iconfont aui-icon-left"></span>
        </a>
        <div class="aui-title">
          <img src="../image/logo.png" width="auto" height="auto" style="margin：0 auto;display: inline-block;" />
        </div>
        <a class="aui-btn aui-pull-right" tapmode>
            <i class="aui-iconfont icon iconfont icon-duihua"></i>
        </a>
    </header>

    <section class="aui-content" id="user-info" >
        <div style="position:relative;width:100%;margin：0 auto;height:150px;">
          <div style="width:100%;height:150px;">
            <span style="color:#ffffff;" id="mmshow"></span>
            <span class="aui-iconfont aui-icon-left" style="font-size: 20px;color:#ffffff;margin-right:20px;"></span>
            <span style="color:#ffffff;font-size: 50px;" id="dateshow"></span>
            <span class="aui-iconfont aui-icon-right" style="font-size: 20px;color:#ffffff;margin-left:20px"></span>
          </div>
        </div>
    </section>

    <section class="aui-content" style="height:300px;">
        <div >

        </div>
    </section>

    <section class="aui-content">
        <div onclick="">
          <img src="../image/sou.png" width="100%" height="auto" style="margin：0 auto;display: inline-block;" />
        </div>
    </section>

    <section class="aui-content" style='background: rgba(0,0,0,0);'>
        <ul class="aui-list aui-list-in aui-margin-b-15" id="alertlist" style='background: rgba(0,0,0,0);'>

        </ul>

    </section>

    <!-- <footer class="aui-bar aui-bar-tab" style="position:fixed;bottom:0px;padding-left:0.8rem;">
        <div class="aui-bar-tab-item aui-active" style="line-height:1.4rem" onclick="fnOpenhomeWin();">
            <i class="aui-iconfont aui-icon-home" style="float:left;margin-left:0.2rem;color:#711173;"></i>
            <div class="aui-bar-tab-label" style="float:left;margin-left:0.2rem;color:#711173;">首页</div>
        </div>
        <div class="aui-bar-tab-item" style="line-height:1.4rem" onclick="fnOpenshouhuanWin();">
            <i class="aui-iconfont icon iconfont icon-icon-test" style="float:left;margin-left:0.2rem;color:#711173;"></i>
            <div class="aui-bar-tab-label" style="float:left;margin-left:0.2rem;color:#711173;">手环</div>
        </div>
        <div class="aui-bar-tab-item" style="line-height:1.4rem">
            <i class="aui-iconfont icon iconfont icon-rili" style="float:left;margin-left:0.2rem;color:#711173;"></i>
            <div class="aui-bar-tab-label" style="float:left;margin-left:0.2rem;color:#711173;">日历</div>
        </div>
        <div class="aui-bar-tab-item" style="line-height:1.4rem" onclick="fnOpenwoWin();">
            <i class="aui-iconfont aui-icon-my" style="float:left;margin-left:0.2rem;color:#711173;"></i>
            <div class="aui-bar-tab-label" style="float:left;margin-left:0.2rem;color:#711173;">我</div>
        </div>
    </footer> -->

    <div style="height: 80px;width: 80px;position: fixed;bottom: 80px;right: 10px;" onclick="fnOpenaddWin();">
      <img src="../image/addicon.png" width="auto" height="auto" style="margin：0 auto;" />
    </div>
    <footer class="aui-bar aui-bar-tab" style="position:fixed;bottom:0px;padding-left:0.8rem;">
        <div class="aui-bar-tab-item aui-active">
            <i class="aui-iconfont icon iconfont icon-rili" style="color:#711173;"></i>
            <div class="aui-bar-tab-label" style="color:#711173;">日历</div>
        </div>
        <div class="aui-bar-tab-item" onclick="fnOpenshouhuanWin();">
            <i class="aui-iconfont icon iconfont icon-7yuyuedingdanwudingdan"></i>
            <div class="aui-bar-tab-label">诊疗</div>
        </div>
        <div class="aui-bar-tab-item" onclick="fnOpenriliWin();">
            <i class="aui-iconfont icon iconfont icon-sound"></i>
            <div class="aui-bar-tab-label">求助</div>
        </div>
        <div class="aui-bar-tab-item" onclick="fnOpenwoWin();">
            <i class="aui-iconfont icon iconfont icon-shebei"></i>
            <div class="aui-bar-tab-label">设备</div>
        </div>
    </footer>

</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript">
var soundArray=new Array();
var titleArray=new Array();
var idArray=new Array();

var myDate = new Date();
        //时间 2016/3/29/00:20
var year = myDate.getFullYear();
        //获取完整的年份(4位,1970-????)  2016
var month = myDate.getMonth()+1;
        //获取当前月份(0-11,0代表1月)  2
var date = myDate.getDate();
        //获取当前日(1-31) 29
var hours = myDate.getHours();
        //获取当前小时数(0-23)  0
var minutes = myDate.getMinutes();
        //获取当前分钟数(0-59)  20
var seconds = myDate.getSeconds();
// alert(date);
var dateshow = document.getElementById('dateshow');


var mmshow = document.getElementById('mmshow');
$api.text(mmshow,year+"年"+month+"月");
$api.text(dateshow,month+"月");
// alert('UICalendar');
var UICalendar;
var clickDay;
var clickYear;
var clickMonth;

var htmlStr1="<li class='aui-list-item' style='background: rgba(0,0,0,0);'><div class='aui-list-item-label-icon'></div><div class='aui-list-item-inner aui-list-item-arrow'><div class='aui-list-item-title'>";
var htmlStr2="</div></div></li>";
var uid = $api.getStorage("userid");
apiready = function() {
  UICalendar = api.require('UICalendar');
  fnOpen();



};

function fnOpen(){
  UICalendar.open({
      rect: {
          x: 30,
          y: 160,
          w: api.frameWidth - 60,
          h: 320
      },
      styles: {
          bg: 'rgba(0,0,0,0)',
          week: {
              weekdayColor: '#ffffff',
              weekendColor: '#ffffff',
              size: 12
          },
          date: {
              color: '#ffffff',
              selectedColor: '#fff',
              selectedBg: '#d45270',
              size: 12
          },
          today: {
              color: '#ffffff',
              bg: '#333333'
          },
          specialDate: {
              color: '#fff'
          }
      },
      specialDate: [{
          date: ''
      }],
      switchMode: 'vertical',
      fixed: false
  }, function(ret, err){
      if( ret ){
          //  alert( JSON.stringify( ret )+'fnOpenwin' );
           var obj = $api.strToJson(ret);
           $api.text(mmshow,ret.year+"年"+ret.month+"月");
           if(ret.day){
             $api.text(dateshow,ret.day);
           }
           clickDay=ret.day;
           clickYear=ret.year;
           clickMonth=ret.month-1;
          //  clickDate=ret.year+"-"+ret.month+"-"+ret.day;
           getAllAlert();

      }else{
          //  alert( JSON.stringify( err ) );
      }
  });
}

function fnSetSpecialDates(){
  UICalendar.setSpecialDates({
      specialDates:[{
         date: '2018-06-29',
         color: '#fff',
         bg: '#0f0'
      },{
         date: '2018-06-30',
         color: '#fff',
         bg: '#0f0'
      }]
  });
}

function fnCancelSpecialDates(){
  UICalendar.cancelSpecialDates({
      specialDates:['2018-06-29','2020-06-30']
  });
}

function fnClose(){
  UICalendar.close();
}

function fnShow(){
  UICalendar.show();
}

function fnHide(){
  UICalendar.hide();
}

function fnNextMonth(){
  UICalendar.nextMonth(function(ret, err){
      if( ret ){
          // alert( JSON.stringify( ret )+'fnNextMonth' );

          var obj = $api.strToJson(ret);
          $api.text(mmshow,obj.year+"年"+obj.month+"月");
      }else{
          // alert( JSON.stringify( err ) );
      }
  });
}

function fnPrevMonth(){
  UICalendar.prevMonth(function(ret, err){
      if( ret ){
          // alert( JSON.stringify( ret )+'fnPrevMonth' );

          var obj = $api.strToJson(ret);
          $api.text(mmshow,obj.year+"年"+obj.month+"月");
      }else{
          // alert( JSON.stringify( err ) );
      }
  });
}

function fnNextYear(){
  UICalendar.nextYear(function(ret, err){
      if( ret ){
          // alert( JSON.stringify( ret ) );
          var obj = $api.strToJson(ret);
          $api.text(mmshow,obj.year+"年"+obj.month+"月");
      }else{
          // alert( JSON.stringify( err ) );
      }
  });
}

function fnPrevYear(){
  UICalendar.prevYear(function(ret, err){
      if( ret ){
          // alert( JSON.stringify( ret ) );
          var obj = $api.strToJson(ret);
          $api.text(mmshow,obj.year+"年"+obj.month+"月");
      }else{
          // alert( JSON.stringify( err ) );
      }
  });
}

function fnSetDate(){
  UICalendar.setDate({
      date: '2015-08-08',
      ignoreSelected: false
  }, function(ret, err){
      if( ret.status ){
          // alert( JSON.stringify( ret ) );
      }else{
          // alert( JSON.stringify( err ) );
      }
  });
}

function fnTurnPage(){
  UICalendar.turnPage({
      date: '2015-08'
  });
}

    // 打开手环Window
    function fnOpenshouhuanWin () {
        api.openWin({
            name: 'shouhuan',
            url: './shouhuan_win.html',
            reload:true,
            pageParam: {
                name: 'shouhuan'
            }
        });
    }

    // 打开日历Window
    function fnOpenriliWin () {
        api.openWin({
            name: 'rili',
            url: './rili_win.html',
            reload:true,
            pageParam: {
                name: 'rili'
            }
        });
    }

    // 打开我Window
    function fnOpenwoWin () {
        api.openWin({
            name: 'wode',
            url: './wode_win.html',
            reload:true,
            pageParam: {
                name: 'wode'
            }
        });
    }

    // 打开添加提醒Window
    function fnOpenaddWin () {
        api.openWin({
            name: 'addmessage',
            url: './addmessage_win.html',
            reload:true,
            pageParam: {
                name: 'test'
            }
        });
    }
    // 打开Window
    function fnOpenhomeWin () {
        api.openWin({
            name: 'home',
            url: './home_win.html',
            reload:true,
            pageParam: {
                name: 'home'
            }
        });
    }


    function getAllAlert(){

      var urlStr = 'http://47.105.67.225/public/index/useraudio/index/userid/'+uid;
      //api.alert({ msg: "uid"+uid });
      //api.alert({ msg: "urlStr"+urlStr });
      api.ajax({
          url: urlStr,
          method: 'get',
      },function(ret, err){
          if (ret) {
              //alert( JSON.stringify( ret ) );
              allAlert=JSON.stringify( ret ) ;
              if(ret.status=="err"){
                var htmlStr = htmlStr1+ret.msg+htmlStr2;
                var el = document.getElementById('alertlist');
                $api.html(el, htmlStr);
              }else{
                // alert( JSON.stringify( ret ) );

                var htmlStr='';

                var m = 0;

                for(var j = 0; j < ret.msg.length; j++){
                  var arr = ret.msg[j].alerttype.split(",");
                  // alert( ret.msg[j].alerttype );clickDate
                  // clickDay=ret.day;
                  // clickYear=ret.year;
                  // clickMonth=ret.month-1;
                  var d=new Date(clickYear,clickMonth,clickDay);
                  for(var i = 0; i < arr.length; i++){
                    if(d.getDay()==arr[i]){
                      var atype='';
                      if(ret.msg[j].ringtype==0){
                        atype='响铃';
                      }
                      if(ret.msg[j].ringtype==1){
                        atype='震动';
                      }

                      soundArray[m] = "http://47.105.67.225/public/uploads/"+ret.msg[j].useraudio;
                      titleArray[m] = ret.msg[j].audiotitle;
                      idArray[m] = ret.msg[j].id;
                      // var htmlStr1="<li class='aui-list-item' onclick='playsound("+m+");'><div class='aui-list-item-label-icon'></div><div class='aui-list-item-inner aui-list-item-arrow'><div class='aui-list-item-title'>";
                      var htmlStr1="<li id='date"+m+"' class='aui-list-item' ontouchend='touchend("+m+")' ontouchmove='gtouchmove()' ontouchstart='touchstart("+m+");'><div class='aui-list-item-label-icon'></div><div class='aui-list-item-inner aui-list-item-arrow'><div class='aui-list-item-title' style='color:#898989'>";
                      var htmlStr2="</div></div></li>";
                      var htmlStrc="</div><div class='aui-list-item-right'>"+ret.msg[j].alerttime;
                      var htmlStra = '['+atype+']'+ret.msg[j].audiotitle+htmlStrc;
                      // alert(htmlStra);
                      htmlStr = htmlStr+htmlStr1+htmlStra+htmlStr2;
                      // alert( htmlStr );
                      m = m+1;

                    }
                  }
                }
                // alert( htmlStr );
                var el = document.getElementById('alertlist');
                $api.html(el, htmlStr);

              }
          }
      });

    }

    function playsound (m) {
      // alert( soundArray[m] );
      soundArray[m] = soundArray[m] .replace("\\\\", "\/\/");
      soundArray[m] = soundArray[m] .replace("\\", "\/");
      soundArray[m] = soundArray[m] .replace("\\", "\/");
      // alert(soundArray[m] );
      var audioStreamer = api.require('audioStreamer');
      audioStreamer.openPlayer({
        path: soundArray[m],
      }, function(ret) {
        if (ret.status) {
            // api.alert({ msg: JSON.stringify(ret) });
        }
      });
    }


    function getTimeNow() {
        var now=new Date();
        return now.getTime();
    }

    var timeStart=0;
    var timeEnd=0;
    var time;//申明全局变量

    function touchend(m){

      // if (timeEnd-timeStart<100) {
      //   // alert('time');
      //
      // }
      playsound(m);
      // timeStart = 0;
      // timeEnd = 0;
      clearInterval(time);//如果按下时间不到1000毫秒便弹起，

    }

    function touchstart(m){
        timeStart=getTimeNow();//获取鼠标按下时的时间
        time=setInterval(function(){
          timeEnd=getTimeNow();//也就是每100毫秒获取一次时间
          if(timeEnd-timeStart>1000)//如果此时检测到的时间与第一次获取的时间差有1000毫秒
          {
            clearInterval(time);//便不再继续重复此函数 （clearInterval取消周期性执行）
            // if($api.attr($api.last(obj),'style')){
            //   $api.removeAttr($api.last(obj),'style');
            // }
            timeStart = 0;
            timeEnd = 0;
            // alert("timeStart:"+timeStart+"timeEnd:"+timeStart);
            delalert(m);
          }
        },100);
    }

    function gtouchmove(){

        clearTimeout(time);

        // timeOutEvent = 0;
        timeStart = 0;
        timeEnd = 0;

        // alert('单击未松开直接滑动的执行代码区，默认取消任何操作');

    }

    function delalert(m){
      // alert("删除");
      var dialogBox = api.require('dialogBox');
      dialogBox.alert({
          texts: {
              title: '确认',
              content: '是否删除"'+titleArray[m]+'"',
              leftBtnTitle: '取消',
              rightBtnTitle: '确认'
          },
          styles: {
              bg: '#fff',
              w: 300,
              corner:2,
              title: {
                  marginT: 20,
                  icon: 'widget://res/gou.png',
                  iconSize: 40,
                  titleSize: 14,
                  titleColor: '#000'
              },
              content: {
                  color: '#000',
                  size: 14
              },
              left: {
                  marginB: 7,
                  marginL: 20,
                  w: 130,
                  h: 35,
                  corner: 2,
                  bg: '#9459b2',
                  color: '#ffffff',
                  size: 12
              },
              right: {
                  marginB: 7,
                  marginL: 10,
                  w: 130,
                  h: 35,
                  corner: 2,
                  bg: '#9459b2',
                  color: '#ffffff',
                  size: 12
              }
          }
      }, function(ret) {
          if (ret.eventType == 'left') {
              var dialogBox = api.require('dialogBox');
              dialogBox.close({
                  dialogName: 'alert'
              });
          }else {
            // alert('删除！！！！');
            deldate (m);
            var dialogBox = api.require('dialogBox');
            dialogBox.close({
                dialogName: 'alert'
            });
          }
      });
    }

    function deldate (m) {
      alert('m:'+m+"--id:"+idArray[m]);
      api.showProgress({
          title: '删除中...',
          text: '请稍等...',
          modal: false
      });
      // var uid = $api.getStorage("userid");

      api.ajax({
        url: 'http://47.105.67.225/public/index/useraudio/delete/id/'+idArray[m],
        method: 'get',
        dataType:'json'
      }, function(ret, err) {
           if (ret) {
             if(ret.status=="ok"){
              api.alert({ msg: ret.msg });
              var el = document.getElementById('date'+m);
              $api.remove(el);
             }else{
               api.alert({ msg: ret.msg });
             }
           }
           api.hideProgress();
        }
      );

    }

</script>
</html>
