<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>设备</title>
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/iconfont/iconfont.css" />
    <style type="text/css">
        .text-white {
            color: #ffffff !important;
        }
        .aui-grid [class*=aui-col-] {
            padding: 0.75rem 0;
        }
    </style>
</head>
<body style="background:url('../image/bg.png') no-repeat;background-size: cover;display：inline">
    <!-- 顶部 -->
    <section class="aui-content">
        <div style="position:relative;width:100%;margin：0 auto;height:400px;">
          <div style="width:100%;text-align:center;height:25px;">

          </div>
          <div style="position:relative;width:100%;text-align:center;height:350px;line-height:350px;">
            <img src="../image/shouhuan.png" width="80%" height="auto" >
          </div>
        </div>
    </section>
    <!-- <section style="height:30px;">
        <div onclick="euowo();">

        </div>
    </section> -->
    <section class="aui-content">
        <ul class="aui-list aui-list-in aui-margin-b-15" id="conlistaa">
            <!-- <li class="aui-list-header">
              手环状态
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner aui-list-item-arrow">
                    <div class="aui-list-item-title">手环电量：78%</div>
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-inner aui-list-item-arrow">
                    <div class="aui-list-item-title">手环容量：28M</div>
                </div>
            </li> -->
            <!-- <li class="aui-list-header">
              手环内容
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-label-icon">

                </div>
                <div class="aui-list-item-inner aui-list-item-arrow">
                    <div class="aui-list-item-title">当天提醒</div>
                </div>
            </li>
            <li class="aui-list-item">
                <div class="aui-list-item-label-icon">

                </div>
                <div class="aui-list-item-inner aui-list-item-arrow">
                    <div class="aui-list-item-title">当天提醒</div>
                </div>
            </li> -->
        </ul>

        <ul class="aui-list aui-list-in aui-margin-b-15">

          <li class="aui-list-item">
              <section class="aui-content-padded" style="width:100%;text-align:center;">
                  <div class="aui-btn aui-btn-block aui-btn-info aui-btn-sm" onclick="getdevice();" tapmode style="background-color: #711173 !important;width:100%;text-align:center;">
                    获取设备
                  </div>
              </section>
          </li>

          <li class="aui-list-item">
              <section class="aui-content-padded" style="width:100%;text-align:center;">
                  <div class="aui-btn aui-btn-block aui-btn-info aui-btn-sm"  onclick="writeUserData();" tapmode style="background-color: #711173 !important;width:100%;text-align:center;">
                    写入用户数据
                  </div>
              </section>
          </li>

          <li class="aui-list-item">
              <section class="aui-content-padded" style="width:100%;text-align:center;">
                  <div class="aui-btn aui-btn-block aui-btn-info aui-btn-sm"  onclick="readUserData();" tapmode style="background-color: #711173 !important;width:100%;text-align:center;">
                    读取用户数据
                  </div>
              </section>
          </li>

          <li class="aui-list-item">
              <section class="aui-content-padded" style="width:100%;text-align:center;">
                  <div class="aui-btn aui-btn-block aui-btn-info aui-btn-sm"  onclick="getDeviceData();" tapmode style="background-color: #711173 !important;width:100%;text-align:center;">
                    读取设备广播数据
                  </div>
              </section>
          </li>

            <li class="aui-list-item">
                <section class="aui-content-padded" style="width:100%;text-align:center;">
                    <div class="aui-btn aui-btn-block aui-btn-info aui-btn-sm"  onclick="isscanble();" tapmode style="background-color: #711173 !important;width:100%;text-align:center;">
                      是否在扫描
                    </div>
                </section>
            </li>

            <li class="aui-list-item">
                <section class="aui-content-padded" style="width:100%;text-align:center;">

                </section>
            </li>


        </ul>

    </section>
    <footer class="aui-bar aui-bar-tab" style="position:fixed;bottom:0px;padding-left:0.8rem;">
        <div class="aui-bar-tab-item aui-active" style="line-height:1.4rem" onclick="fnOpenhomeWin();">
            <i class="aui-iconfont aui-icon-home" style="float:left;margin-left:0.2rem;color:#711173;"></i>
            <div class="aui-bar-tab-label" style="float:left;margin-left:0.2rem;color:#711173;">首页</div>
        </div>
        <div class="aui-bar-tab-item" style="line-height:1.4rem">
            <i class="aui-iconfont icon iconfont icon-icon-test" style="float:left;margin-left:0.2rem;color:#711173;"></i>
            <div class="aui-bar-tab-label" style="float:left;margin-left:0.2rem;color:#711173;">手环</div>
        </div>
        <div class="aui-bar-tab-item" style="line-height:1.4rem" onclick="fnOpenriliWin();">
            <i class="aui-iconfont icon iconfont icon-rili" style="float:left;margin-left:0.2rem;color:#711173;"></i>
            <div class="aui-bar-tab-label" style="float:left;margin-left:0.2rem;color:#711173;">日历</div>
        </div>
        <div class="aui-bar-tab-item" style="line-height:1.4rem" onclick="fnOpenwoWin();">
            <i class="aui-iconfont aui-icon-my" style="float:left;margin-left:0.2rem;color:#711173;"></i>
            <div class="aui-bar-tab-label" style="float:left;margin-left:0.2rem;color:#711173;">我</div>
        </div>
    </footer>
</body>
<script type="text/javascript" src="../script/api.js" ></script>
<script type="text/javascript">
// alert('date');
apiready = function() {
startble();
};

var uuid = [];
var uuname = [];
var ssid = [];
var deviceid = 0;

function startble(){
  var ble = api.require('ble');
    ble.initManager(function(ret) {
      // api.alert({ msg: JSON.stringify(ret) });
        if (ret.state == "poweredOn") {
            // api.alert({ msg: "初始化成功" });
            // euowo();
            ble.scan({
            }, function(ret) {
                if (ret.status) {
                  // api.alert({ msg: JSON.stringify(ret) });
                  getdevice();
                }
            });
        }
    });
}


function getdevice(){
  var htmlStr = "<li class='aui-list-header'>蓝牙设备</li>";
  var ble = api.require('ble');
  ble.getPeripheral(function(ret) {
      if (ret) {
        // api.alert({ msg: JSON.stringify(ret) });
          if(ret.peripherals.length>0){

            for(var i = 0; i < ret.peripherals.length; i++){
              // alert(ret.peripherals[i].name);
              uuid[i] = ret.peripherals[i].uuid;
              // ssid[i] = ret.characteristics[i].serviceUUID;
              var htmlStra = "未命名设备";
              if(ret.peripherals[i].name){
                htmlStra = ret.peripherals[i].name;
                uuname[i] = ret.peripherals[i].name;
              }else{
                uuname[i] = "未命名设备";
              }
              var htmlStr1 = "<li class='aui-list-item' onclick='deviceconnect("+i+");'><div class='aui-list-item-inner aui-list-item-arrow'><div class='aui-list-item-title'>";
              var htmlStr2 = "</div></div></li>";
              htmlStr = htmlStr + htmlStr1 + htmlStra + htmlStr2;

            }

            // alert(htmlStr);
            var el = document.getElementById('conlistaa');
            $api.html(el, htmlStr);
          }

      }
  });

}

function getDeviceData(){
  // alert("uuid:"+uuid[deviceid]);
  // alert("uuname:"+uuname[deviceid]);
  var ble = api.require('ble');
  ble.readValueForCharacteristic({
    peripheralUUID: uuid[deviceid],
    // peripheralUUID: "0000ff20-0000-1000-8000-00805f9b34fb",
    serviceUUID: "0000ff20-0000-1000-8000-00805f9b34fb",
    characteristicUUID: "0000ff24-0000-1000-8000-00805f9b34fb"
  }, function(ret,err) {
    api.alert({ msg: JSON.stringify(ret) });
    api.alert({ msg: JSON.stringify(err) });
      // if (ret) {
      //
      // }else {
      //
      //
      // }
  }
);
}

function writeUserData(){
  // alert("uuid:"+uuid[deviceid]);
  // alert("uuname:"+uuname[deviceid]);
  var ble = api.require('ble');
  ble.writeValueForCharacteristic({
    peripheralUUID: uuid[deviceid],
    serviceUUID: "0000ff20-0000-1000-8000-00805f9b34fb",
    characteristicUUID: "0000ff21-0000-1000-8000-00805f9b34fb",
    value: '12345678',
    writeType:'withoutResponse'
  }, function(ret,err) {
    // alert("writeUserData:-----");
    // api.alert({ msg: JSON.stringify(err) });
    api.alert({ msg: JSON.stringify(ret) });
    // api.alert({ msg: JSON.stringify(err) });
      if (ret) {

      }else {


      }
  }
);
}


function readUserData(){
  // alert("uuid:"+uuid[deviceid]);
  // alert("uuname:"+uuname[deviceid]);
  var ble = api.require('ble');
  ble.readValueForDescriptor({
    peripheralUUID: uuid[deviceid],
    serviceUUID: "0000ff20-0000-1000-8000-00805f9b34fb",
    characteristicUUID: "0000ff21-0000-1000-8000-00805f9b34fb"
    // descriptorUUID:
    // value: '0x010x010037000100ac00450057'
  }, function(ret,err) {
    // api.alert({ msg: JSON.stringify(err) });
    // api.alert({ msg: JSON.stringify(ret) });
    // api.alert({ msg: JSON.stringify(err) });
      // if (ret) {
      //
      // }else {
      //
      //
      // }
  }
);
}



function deviceconnect(m){
  // alert(uuid[m]);
  deviceid = m;
  var ble = api.require('ble');
  ble.connect({
      peripheralUUID: uuid[m]
  }, function(ret, err) {
      if (ret.status) {
          alert("连接成功！");
          ble.discoverService({
              peripheralUUID: uuid[m]
          }, function(ret) {
              if (ret) {
                  // api.alert({ msg: JSON.stringify(ret) });
                  ble.discoverCharacteristics({
                      peripheralUUID: uuid[m],
                      serviceUUID: "0000ff20-0000-1000-8000-00805f9b34fb"
                  }, function(ret) {
                      if (ret) {
                          api.alert({ msg: JSON.stringify(ret) });
                      }
                  });
              }
          });

      } else {
          // alert(err.code);
          alert("连接失败");
      }
  });
}

function isscanble(){
  var ble = api.require('ble');
  ble.isScanning(function(ret) {
    api.alert({ msg: JSON.stringify(ret) });
  })
}

function stopscanble(){
  var ble = api.require('ble');
  ble.stopScan();
}

// discoverCharacteristics根据指定的外围设备 UUID 及其服务 UUID 获取该外围设备的所有特征（Characteristic）
// discoverService根据指定的外围设备 UUID 获取该外围设备的所有服务


    var myDate = new Date();
            //时间 2016/3/29/00:20
    var year = myDate.getFullYear();
            //获取完整的年份(4位,1970-????)  2016
    var month = myDate.getMonth();
            //获取当前月份(0-11,0代表1月)  2
    var date = myDate.getDate();
            //获取当前日(1-31) 29
    var hours = myDate.getHours();
            //获取当前小时数(0-23)  0
    var minutes = myDate.getMinutes();
            //获取当前分钟数(0-59)  20
    var seconds = myDate.getSeconds();
    // alert(date);
    var dateshow = document.getElementById('dateshow');
    $api.text(dateshow,date);

    var mmshow = document.getElementById('mmshow');
    $api.text(mmshow,year+"年"+month+"月");


    // 打开手环Window
    function fnOpenshouhuanWin () {
        api.openWin({
            name: 'shouhuan',
            url: './shouhuan_win.html',
            pageParam: {
                name: 'shouhuan'
            }
        });
    }

    // 打开日历Window
    function fnOpenriliWin () {
        api.openWin({
            name: 'rili',
            url: './rili_win.html',
            pageParam: {
                name: 'rili'
            }
        });
    }

    // 打开我Window
    function fnOpenwoWin () {
        api.openWin({
            name: 'wode',
            url: './wode_win.html',
            pageParam: {
                name: 'wode'
            }
        });
    }

    // 打开添加提醒Window
    function fnOpenaddWin () {
        api.openWin({
            name: 'addmessage',
            url: './addmessage_win.html',
            pageParam: {
                name: 'test'
            }
        });
    }
    // 打开Window
    function fnOpenhomeWin () {
        api.openWin({
            name: 'home',
            url: './home_win.html',
            pageParam: {
                name: 'home'
            }
        });
    }




</script>
</html>
